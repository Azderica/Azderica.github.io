<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">

<head>
  <title>달리는 인증 서비스의 NoSQL을 바꾸자. - 후기 - Azderica</title><meta name="gridsome:hash" content="a494b8b1778660c606708ae3dd5d59774a4a3863"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="부족하지만 꿈많은 웹 개발자의 발전 기록입니다."><meta data-vue-tag="ssr" name="description" content="달리는 인증 서비스의 NoSQL을 바꾸자. - 후기"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.d0be325ebfe2762f973f3e0685345394.png"><link rel="preload" href="/assets/css/0.styles.359a0b77.css" as="style"><link rel="preload" href="/assets/js/app.e68d9618.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--post-vue.e5244b0f.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.cf9c1447.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.5770a427.js"><link rel="prefetch" href="/assets/js/page--src--templates--tag-vue.5957f7f4.js"><link rel="stylesheet" href="/assets/css/0.styles.359a0b77.css"><script data-vue-tag="ssr" type="text/javascript" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  <script data-ad-client="ca-pub-1759762070891290" async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FCHHPLPKYW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-FCHHPLPKYW');
  </script>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="shortcut icon" type="image/png" href="favicon.png" />
  <meta name="google-site-verification" content="MqpGCz7XVg4s3AWfrGHCt6AlXPacpV9iGvSFVD0ATHw" />
</head>

<body >
  <script>
    // Add dark / light detection that runs before Vue.js load. Borrowed from overreacted.io
    ; (function () {
      window.__onThemeChange = function () { }
      function setTheme(newTheme) {
        window.__theme = newTheme
        preferredTheme = newTheme
        document.body.setAttribute('data-theme', newTheme)
        window.__onThemeChange(newTheme)
      }

      var preferredTheme
      try {
        preferredTheme = localStorage.getItem('theme')
      } catch (err) { }

      window.__setPreferredTheme = function (newTheme) {
        setTheme(newTheme)
        try {
          localStorage.setItem('theme', newTheme)
        } catch (err) { }
      }

      var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
      darkQuery.addListener(function (e) {
        window.__setPreferredTheme(e.matches ? 'dark' : 'light')
      })

      setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
    })()
  </script>

  <div id="app" data-server-rendered="true"><header class="header"><div class="header__left"><a href="/" class="logo active"><span class="logo__text">
    ← Azderica
  </span></a></div><div class="header__right"><button role="button" aria-label="Toggle dark/light" class="toggle-theme"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button></div></header><main class="main"><div class="post-title"><h1 class="post-title__text">
      달리는 인증 서비스의 NoSQL을 바꾸자. - 후기
    </h1><div class="post-meta">
   Posted 15. May 2023.
   <strong>11 min read.</strong></div></div><div class="post content-box"><div class="post__header"><!----></div><div class="post__content"><h1 id="달리는-인증-서비스의-nosql을-바꾸자---후기"><a href="#%EB%8B%AC%EB%A6%AC%EB%8A%94-%EC%9D%B8%EC%A6%9D-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-nosql%EC%9D%84-%EB%B0%94%EA%BE%B8%EC%9E%90---%ED%9B%84%EA%B8%B0" aria-hidden="true"><span class="icon icon-link"></span></a>달리는 인증 서비스의 NoSQL을 바꾸자. - 후기</h1>
<p>회사에서 진행한 글에 대한 뒷이야기와 생각을 작성합니다.</p>
<ul>
<li><a href="https://dev.gmarket.com/77" target="_blank" rel="nofollow noopener noreferrer">원본, 달리는 인증 서비스의 NoSQL을 바꾸자 - 전략편</a></li>
<li><a href="https://dev.gmarket.com/78" target="_blank" rel="nofollow noopener noreferrer">원본, 달리는 인증 서비스의 NoSQL을 바꾸자 - 실전편</a></li>
</ul>
<br/>
<h2 id="작업에-대한-생각"><a href="#%EC%9E%91%EC%97%85%EC%97%90-%EB%8C%80%ED%95%9C-%EC%83%9D%EA%B0%81" aria-hidden="true"><span class="icon icon-link"></span></a>작업에 대한 생각</h2>
<p>아는 사람한테 이 작업을 마무리 했을 때, 정말 겁이 없다라는 이야기를 들었다. 어느정도 나도 공감하는 이슈이다. 회사에서 어찌저찌 돌아가고 있는 서비스를 갈아엎는다는 것은 따로 얻는 것 없이 리스크를 짊어지는 것이라고 생각한다.</p>
<p>물론 이 작업이 필요가 없는 작업이였나 물어보면, 반드시 필요한 작업이였다. 그러나 이 필요한 작업을 남들에게 설득시킬 수 있는 것은 다른 문제라고 생각한다. 개발자 입장과 기획자에서는 반드시 필요한 작업이였으나, 이를 사용하는 유저 입장에서는 정말 티가 안나는 작업이다. 큰틀에서 보면 백엔드 개발자로서 겪는 문제라고도 느낀다. 그러나 미래의 작업을 위해서 꼭 해야했던 작업이었다.</p>
<p>앞서 원글에서 이야기 했듯 이 작업을 진행할 때는 어떻게든 비즈니스와 엮어서 진행한다. 작은 비즈니스적인 개선을 하더라도 이를 같이 수면 위로 드러나게 하여, 결과가 나오게 작업을 만들고 싶다. 이럴 때 커뮤니케이션의 실력과, 비즈니스 인사이트, 개발 실력에 대한 하모니가 필요한 시점이라고 생각한다.</p>
<br/>
<h2 id="레거시에-대한-전략"><a href="#%EB%A0%88%EA%B1%B0%EC%8B%9C%EC%97%90-%EB%8C%80%ED%95%9C-%EC%A0%84%EB%9E%B5" aria-hidden="true"><span class="icon icon-link"></span></a>레거시에 대한 전략</h2>
<p>레거시에 대한 생각은 꾸준히 바뀌는 것 같다. 입사하기전이나 초창기에는 레거시는 무조건 나쁘다라는 생각이 있었다. 레거시의 의미 개념을 생각하면 얼추 맞는말이긴한데, 관리를 안한 코드의 문제이고, 이는 개발자, 자원을 주지 않은 회사의 문제라고 생각한다.</p>
<p>관련해서는 그래서 욕심이 좀 있다. 내가 이 도메인을 책임진다면, 내가 역사를 하나 쓰고 싶다는 것. 과거 10년~20년 된 코드를 내 선에서 끊고, 신규 서비스를 진행할 준비를 하고 싶다는 것이 가장 큰 욕심이다.</p>
<p>이번에 서비스 개선 등을 진행하며, 동시에 작업하는 것이 많다. 내 업무시간에 하는 회사일도 있고, 퇴근해서 또 하는 다른 회사일, 주말에도 회사일을 좀 본다. 개인적인 욕심이 좀 많다.</p>
<p>회사가 나를 어떻게 볼지는 모르지만, 나는 회사에 대한 애사심이 좀 많은 것 같다. 회사의 서비스에서 셀러 서비스가 난 약점이라고 생각하고, 물론 그 약점이 우리팀에 있는 것은 아니고 모든 팀이 다 걸쳐있겠지만, 그 중에서 난 우리팀이 가장 변화에 적응할 수 있는 팀이 되고 싶다. 솔직히 더 본심을 이야기하면 내가 있는 조직이 언제나 변화에 가장 크게 적응하는 팀이 되고 싶다.</p>
<p>내가 개발자라는 직업을 좋아하는 이유는 정말 노력하고 투자하면, 2명 혹은 3명, 혹은 그 이상 10명 치의 일을 할 수 있다는 점이다. 그렇기 때문에 더 노력하고, 갈고 닦고 싶다. 다들 알다시피, 개발자들이 개발하는 모습을 보면 코드를 고민하는 시간이 대부분이고, 검색하는 부분이 대부분의 시간을 차지하고 코드를 짜는 시간은 어찌보면 그렇게 많지 않다.</p>
<p>고민과 검색하는 시간을 코드로 짜는 시간으로 바꾸고, 코드를 짜면서 그 고민과 검색하는 시간을 압도적으로 줄일 수 있으면 어떨까? 그 사람은 엄청난 시간과 에너지를 아껴서 퍼포먼스를 만들 수 있다고 생각한다.</p>
<p>과거 읽은 책 중 하나가, 업무를 하다가 다른 창, 화면을 보는 것이 엄청난 집중력 저하를 일으킨다는 연구결과를 본적이 있다. 개발을 할 때도 마찬가지라고 생각한다. 그래서 좀 더 효율의 극대화, 비즈니스의 방향 추구 등이 내 요즘 최고의 관심사다.</p>
<br/>
<h2 id="배포하고-발생한-이슈"><a href="#%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B3%A0-%EB%B0%9C%EC%83%9D%ED%95%9C-%EC%9D%B4%EC%8A%88" aria-hidden="true"><span class="icon icon-link"></span></a>배포하고 발생한 이슈</h2>
<p>언제나 그렇듯 큰 배포가 나가고 나면 여러가지 이슈가 발생한다. 큰 이슈는 발생하지 않도록 하나 여러 작은 이슈들이 발생한다. 그 이슈의 작고 큰 유무는 개인의 판단에 다르고, 회사 측면에서도 다르나 일종의 버그이니 얼른 해결을 해야한다고 생각한다.</p>
<br/>
<h3 id="1-couchbase-와-mongodb-전환시-map-형태의-차이"><a href="#1-couchbase-%EC%99%80-mongodb-%EC%A0%84%ED%99%98%EC%8B%9C-map-%ED%98%95%ED%83%9C%EC%9D%98-%EC%B0%A8%EC%9D%B4" aria-hidden="true"><span class="icon icon-link"></span></a>1. Couchbase 와 MongoDB 전환시 Map 형태의 차이</h3>
<p>놀랍게도 이커머스의 초창기 회사에 있기에 여러가지 아이디 계정을 보게된다. 아이디는 대부분의 서비스에서 유효한 키를 차지하기에 한번 생기면 바꾸기가 거의 어렵다. 특히 몇년동안 쌓인 잘못된 정책의 데이터가 이후 변경을 힘들게한다. 특히 초창기의 웹 서비스에서는 아이디에 대한 규칙이 없기 때문에 그 규칙을 깬 계정으로 인해 여러 서비스에서 방어로직을 넣고 서비스 이슈가 발생하게 됩니다. (대표적인 예시가 특수문자와 공백입니다.)</p>
<p>근데 이번에 작업을 하면서 특정 계정의 경우, 아이디에 "." 가 들어가는 문제가 있었습니다.  Couchbase에서는 map 데이터에 "." 가 들어가는게 허용이 되는데, MongoDB에서는 이 값을 사용할 수가 없습니다. 그래서 싱크 때 여러 버그가 터지는 케이스가 있었습니다. 이런 부분을 치환해서 저장을 해야하는데, 치환해서 저장한다는 것은 다른 곳에서도 볼때마다 치환해서 봐야한다는 사실을 의미합니다. 즉, 여러 서비스에서 공통적으로 사용해야 한다는 것입니다.</p>
<br/>
<h3 id="2-급격한-성능-저하"><a href="#2-%EA%B8%89%EA%B2%A9%ED%95%9C-%EC%84%B1%EB%8A%A5-%EC%A0%80%ED%95%98" aria-hidden="true"><span class="icon icon-link"></span></a>2. 급격한 성능 저하</h3>
<p>couchbase에서 mongodb로 전환했을 때 바로 성능이 따라오냐는 다른 문제입니다. 그리고 그 문제는 직접적으로 발생했습니다. 따라서 어떤식으로든 최적화가 필요한 상태입니다. 기존에서 couchbase에서 나오던 latency의 2배 ~ 3배 정도로 더 느려졌습니다.</p>
<p>추측은 다음과 같습니다.</p>
<ul>
<li>id로 접근을 특정 value로 접근을 해서 (다만, value로 indexing 처리를 했습니다.)</li>
<li>mongodb보다 couchbase가 더 빨라서.</li>
<li>최적화가 되지 않아서.</li>
</ul>
<br/>
<h3 id="3-일부-데이터-검증-방법"><a href="#3-%EC%9D%BC%EB%B6%80-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EA%B2%80%EC%A6%9D-%EB%B0%A9%EB%B2%95" aria-hidden="true"><span class="icon icon-link"></span></a>3. 일부 데이터 검증 방법</h3>
<p>데이터 양을 비교하는 것도 고민을 해야합니다. couchbase와 mongodb의 document 수가 같은지, 다르다면 어디서 차이가 나는지 걱정을 해야합니다.</p>
<p>mongodb의 퍼포먼스를 올릴 수 있는 코드를 찾고 있고, 그 코드를 체크할 부분을 찾아야합니다.</p>
<p>대표적인 예시로 find 가 아닌 findTop 으로 바꿨고, 더 빠른 처리를 고민하고 있습니다.</p>
<p>primary index와 secondary index의 차이가 있는지도 체크가 필요합니다.</p>
<p>어떤식으로 할 수 있을까... 생각보다 코드가 안나온다... 검색 체크가 필요한데...</p>
<br/>
<h2 id="해결-방식"><a href="#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EC%8B%9D" aria-hidden="true"><span class="icon icon-link"></span></a>해결 방식</h2>
<h3 id="1-mongodb-converter-사용"><a href="#1-mongodb-converter-%EC%82%AC%EC%9A%A9" aria-hidden="true"><span class="icon icon-link"></span></a>1. MongoDB Converter 사용</h3>
<p><code class="language-text">&quot;.&quot;</code> 을 어떤걸로 전환을 할까 했는데, 결국은 아스키로 저장을 했습니다. <code class="language-text">&quot;&amp;#46;&quot;</code> 으로 변경해서 저장을 했고, 그 외에 어떤 특수문자를 할까 고민을 했는데 괜찮은 게 없었다.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUpMongoEscapeCharacterConversion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mongoConverter<span class="token punctuation">.</span><span class="token function">setMapKeyDotReplacement</span><span class="token punctuation">(</span><span class="token string">"&amp;#46;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<br/>
<h3 id="2-성능-저하-해결"><a href="#2-%EC%84%B1%EB%8A%A5-%EC%A0%80%ED%95%98-%ED%95%B4%EA%B2%B0" aria-hidden="true"><span class="icon icon-link"></span></a>2. 성능 저하 해결</h3>
<p>데이터가 어디서 시간이 많이 걸리는지 체크를 했는데, 특정 document를 접근하는 경우가 제일 많은 시간과 요청이 있었다. 그 값은 자주 변경되는 값이 아니기 때문에 1분 캐시를 먹여서 해결을 했다. 정말 드라마틱하게 mongodb의 트래픽을 줄였고 서비스 적으로도 이슈가 없었다.</p>
<p><img src="https://github.com/Azderica/til/assets/42582516/a8c9ef2a-fbb5-4eac-a813-3f3d72ab9df5" alt="image"></p>
<p>mongodb에서도 건드릴 수 있는 부분이 있으면 체크를 할려고 했으나, 그 부분을 잘 해결되지 않았다.</p>
<h3 id="3-노가다로-맞춘다"><a href="#3-%EB%85%B8%EA%B0%80%EB%8B%A4%EB%A1%9C-%EB%A7%9E%EC%B6%98%EB%8B%A4" aria-hidden="true"><span class="icon icon-link"></span></a>3. 노가다로 맞춘다.</h3>
<p>데이터는 억지로 맞추고, 버그 발생시 즉각적 대응 및 버그를 계속 체크한다.</p>
<br/>
<h2 id="어떻게-더-나아갈-수-있을까"><a href="#%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8D%94-%EB%82%98%EC%95%84%EA%B0%88-%EC%88%98-%EC%9E%88%EC%9D%84%EA%B9%8C" aria-hidden="true"><span class="icon icon-link"></span></a>어떻게 더 나아갈 수 있을까?</h2>
<p>가장 어려운 부분이라고 생각한다. 특히, 나는 야근과 주말일이 가득한 사람이고 내 개인적인 욕심이 많기 때문에 남한테 이를 강요할 수는 없다. 최근 토스에서 이야기가 많은 것처럼, 나또한 내 욕심이 남의 철학을 건드려서는 안된다고 생각한다. 각자 자신의 스타일이 있고 그 스타일을 조율하는 것이 중요하다고 생각한다.</p>
<p>함께 가며, 전략적으로 가는 방법. 그리고 그들의 본심을 꺼낼 수 있는 방식을 가고 싶다. 그리고 나는 남들을 평가할 수 없으나, 남들에게 무언가를 부탁하려면 그 이상의 작업을 해야한다고 생각한다. 그래서 나는 남들이 하는 작업의 두배이상을 하려고한다. 그래야지, 다른 사람에게 뭔가를 이야기할 명분이 생긴다고 생각한다.</p>
</div><div class="post__footer"><div class="post-tags"><a href="/tag/Developer/" class="post-tags__link"><span>#</span> Developer
		</a><a href="/tag/Couchbase/" class="post-tags__link"><span>#</span> Couchbase
		</a><a href="/tag/MongoDB/" class="post-tags__link"><span>#</span> MongoDB
		</a><a href="/tag/MSDB/" class="post-tags__link"><span>#</span> MSDB
		</a><a href="/tag/Migration/" class="post-tags__link"><span>#</span> Migration
		</a></div></div></div><div class="post-comments" style="display:none;"></div><div class="post-comments"></div><div class="author post-author"><img alt="Author image" src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 180 180' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-bfb91fc8d3516221a47de6ec13d7cf4f'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='5'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-bfb91fc8d3516221a47de6ec13d7cf4f)' width='180' height='180' xlink:href='data:image/jpeg%3bbase64%2c/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCABAAEADASIAAhEBAxEB/8QAHAAAAQUBAQEAAAAAAAAAAAAABgEDBAcIBQIA/8QAMBAAAQMDAgQFAwQDAQAAAAAAAQIDBAAFERIhBhMxUQciQWFxFJGhFiMygRVCsdH/xAAYAQADAQEAAAAAAAAAAAAAAAABAgMABP/EACARAAICAgICAwAAAAAAAAAAAAECABEDEiExBCITQUL/2gAMAwEAAhEDEQA/ALKr4mmyo5pdVPJXFNIakR4ynUlaspbAznHX4qp/EzxOTw9LctVnQ07cEpBW%2b4QW2sjYY9VfOMe9LuLqNowFyzx0pDWTX%2bM%2bIZMovOcQT9ZUFYbdKQD8DbHxWg/Cy7XriC0xZl%2bTEYiyBy4i06ua%2bpOcqV/qAcHHqaBcDuMqMxoQtNeTUiayGVJKM6TsQeqVDqKjUVYMLEzKVNGeiupMCOZTnZtP8jTcSGp/C3Mpa/JqJfLythf0VrbQp0DzFX8UDuankyfle4%2bLFfs/AnL4x42t9puRgPsZitMuPPSCSSjSkkBCR1Vt%2bM1Stv8ADfibjGQ5f5S4Mf6xfNCJWvUpJ6FSUjbbHrmrNn8PNTo036xXOkymy2VgYCQrY4HxtRBw5DegyHhHhpiAq0lZeLnNGNlHI2PpjeoHbH33Oz0zGh0JRvF/hfxBbYvPiRbc4003%2b43BdcKlnfK9Lm5PsD0HSjjwB46uHEN/uFivKkGN9Ml2KylGAyWyElI7DGDjvRRf1SHJMlEh66ocLepK2NJYwTgJ0k5J37dM71WEaR%2bkfEW0Xvkqw4tUeWllJ8yVDBUB3Gx/qtvtw0Pw6cpNFXZCkMuDqcZz8Vy0kFIPcV3w7HutuS7GcS4hadSVJ6GhoL5bqmVbLRtg0%2bA0SJDyFNAx%2b/XUsIDMfd1Ww/8Aa4DCNIJJJKjlSj1Ue9DDvHvDqOfImXNlK9ZSkDKjgdgM1HV4l8MJjB4zHic45YYUV/bpj%2b6piUKLPcjmcsaHUN0Hzox1yK6z85wJy0yXloQf2kKAVn060B/rOxC1xLg7cEMsSgS0Fg6zg4PlGTsaM7KLbxxZ2btZ5KCtOWXkLRgpUOpwfQ7GtlTeiJTxMioSH6ntcpSLQtU1gIcGdshRx6Zx61XCoKLnci88hTSUkltWN09Onuf%2bVYlybs/DlsU2FtyX86iEKyhJ7k%2bp9qDVXBMyQ64CnmZBWkHdORtkfGKgMPNMZ0t5OtsghxwI%2bhhKoKAEtgakJAwB3p/iqERiUyPOnc49aGLDK5FxYWFY82D8GrGdQmRG3wQRRcatxJo26%2b0wVpK0kDb4pWm3HGwlIyoq0bd6QOBCCTXbtLIMaK6oDSnU8fk9KuBc4pDlQzGmuac%2bVsKH23/Io/8ADriViySXY90b5lskJAdSUatB9FY6/b27UKzG%2bdIQsbamSPuRXp0aClY9Nj8U2sIYjmWNfeIOHks86LeA7g4RFRGWgJHck7mq2uV0luXQ3GO%2b8zLkrAy2op0J7bewFNTUnWgBX8t6bbwJaUkbcsn8ikCAG5R8zMoX6EIovGd8YkM65ijo3xoTggeh23PvWrrFLTMtzLqCClxtK0/BGaxo6%2bhSlKO2lRT8d60t4MXX/IcFW4knWyDHUD1Gk4H4xSZR0Y%2bA8kT/2Q==' /%3e%3c/svg%3e" width="180" data-src="/assets/static/author.e6b6009.98a7113f4952b5eaa532b5d16696f13d.jpg" data-srcset="/assets/static/author.e6b6009.98a7113f4952b5eaa532b5d16696f13d.jpg 180w" data-sizes="(max-width: 180px) 100vw, 180px" class="author__image g-image g-image--lazy g-image--loading"><noscript><img src="/assets/static/author.e6b6009.98a7113f4952b5eaa532b5d16696f13d.jpg" class="author__image g-image g-image--loaded" width="180" alt="Author image"></noscript><!----><p class="author__intro">To be a Pro in Web developer</p><p class="author__links"><a href="//linkedin.com/in/myeonghun-park-7693a1184/">📘 Linkedin</a><a href="//azderica.github.io/til/docs/intro">📚 TIL</a><a href="//github.com/Azderica">💻 GitHub</a><a href="//azderica.github.io/Portfolio/" target="_blank">✨ Portfolio</a></p></div></main><footer class="footer"><span class="footer__copyright">Copyright © 2023.
    </span><span class="footer__links">Powered by <a href="//gridsome.org"> Gridsome </a></span></footer></div> <script>window.__INITIAL_STATE__={"data":{"post":{"title":"달리는 인증 서비스의 NoSQL을 바꾸자. - 후기","path":"\u002Fnosql-couchbase-to-mongodb\u002F","date":"15. May 2023","timeToRead":11,"tags":[{"id":"Developer","title":"Developer","path":"\u002Ftag\u002FDeveloper\u002F"},{"id":"Couchbase","title":"Couchbase","path":"\u002Ftag\u002FCouchbase\u002F"},{"id":"MongoDB","title":"MongoDB","path":"\u002Ftag\u002FMongoDB\u002F"},{"id":"MSDB","title":"MSDB","path":"\u002Ftag\u002FMSDB\u002F"},{"id":"Migration","title":"Migration","path":"\u002Ftag\u002FMigration\u002F"}],"description":"달리는 인증 서비스의 NoSQL을 바꾸자. - 후기","content":"\u003Ch1 id=\"달리는-인증-서비스의-nosql을-바꾸자---후기\"\u003E\u003Ca href=\"#%EB%8B%AC%EB%A6%AC%EB%8A%94-%EC%9D%B8%EC%A6%9D-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%9D%98-nosql%EC%9D%84-%EB%B0%94%EA%BE%B8%EC%9E%90---%ED%9B%84%EA%B8%B0\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E달리는 인증 서비스의 NoSQL을 바꾸자. - 후기\u003C\u002Fh1\u003E\n\u003Cp\u003E회사에서 진행한 글에 대한 뒷이야기와 생각을 작성합니다.\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fdev.gmarket.com\u002F77\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003E원본, 달리는 인증 서비스의 NoSQL을 바꾸자 - 전략편\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fdev.gmarket.com\u002F78\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"\u003E원본, 달리는 인증 서비스의 NoSQL을 바꾸자 - 실전편\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cbr\u002F\u003E\n\u003Ch2 id=\"작업에-대한-생각\"\u003E\u003Ca href=\"#%EC%9E%91%EC%97%85%EC%97%90-%EB%8C%80%ED%95%9C-%EC%83%9D%EA%B0%81\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E작업에 대한 생각\u003C\u002Fh2\u003E\n\u003Cp\u003E아는 사람한테 이 작업을 마무리 했을 때, 정말 겁이 없다라는 이야기를 들었다. 어느정도 나도 공감하는 이슈이다. 회사에서 어찌저찌 돌아가고 있는 서비스를 갈아엎는다는 것은 따로 얻는 것 없이 리스크를 짊어지는 것이라고 생각한다.\u003C\u002Fp\u003E\n\u003Cp\u003E물론 이 작업이 필요가 없는 작업이였나 물어보면, 반드시 필요한 작업이였다. 그러나 이 필요한 작업을 남들에게 설득시킬 수 있는 것은 다른 문제라고 생각한다. 개발자 입장과 기획자에서는 반드시 필요한 작업이였으나, 이를 사용하는 유저 입장에서는 정말 티가 안나는 작업이다. 큰틀에서 보면 백엔드 개발자로서 겪는 문제라고도 느낀다. 그러나 미래의 작업을 위해서 꼭 해야했던 작업이었다.\u003C\u002Fp\u003E\n\u003Cp\u003E앞서 원글에서 이야기 했듯 이 작업을 진행할 때는 어떻게든 비즈니스와 엮어서 진행한다. 작은 비즈니스적인 개선을 하더라도 이를 같이 수면 위로 드러나게 하여, 결과가 나오게 작업을 만들고 싶다. 이럴 때 커뮤니케이션의 실력과, 비즈니스 인사이트, 개발 실력에 대한 하모니가 필요한 시점이라고 생각한다.\u003C\u002Fp\u003E\n\u003Cbr\u002F\u003E\n\u003Ch2 id=\"레거시에-대한-전략\"\u003E\u003Ca href=\"#%EB%A0%88%EA%B1%B0%EC%8B%9C%EC%97%90-%EB%8C%80%ED%95%9C-%EC%A0%84%EB%9E%B5\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E레거시에 대한 전략\u003C\u002Fh2\u003E\n\u003Cp\u003E레거시에 대한 생각은 꾸준히 바뀌는 것 같다. 입사하기전이나 초창기에는 레거시는 무조건 나쁘다라는 생각이 있었다. 레거시의 의미 개념을 생각하면 얼추 맞는말이긴한데, 관리를 안한 코드의 문제이고, 이는 개발자, 자원을 주지 않은 회사의 문제라고 생각한다.\u003C\u002Fp\u003E\n\u003Cp\u003E관련해서는 그래서 욕심이 좀 있다. 내가 이 도메인을 책임진다면, 내가 역사를 하나 쓰고 싶다는 것. 과거 10년~20년 된 코드를 내 선에서 끊고, 신규 서비스를 진행할 준비를 하고 싶다는 것이 가장 큰 욕심이다.\u003C\u002Fp\u003E\n\u003Cp\u003E이번에 서비스 개선 등을 진행하며, 동시에 작업하는 것이 많다. 내 업무시간에 하는 회사일도 있고, 퇴근해서 또 하는 다른 회사일, 주말에도 회사일을 좀 본다. 개인적인 욕심이 좀 많다.\u003C\u002Fp\u003E\n\u003Cp\u003E회사가 나를 어떻게 볼지는 모르지만, 나는 회사에 대한 애사심이 좀 많은 것 같다. 회사의 서비스에서 셀러 서비스가 난 약점이라고 생각하고, 물론 그 약점이 우리팀에 있는 것은 아니고 모든 팀이 다 걸쳐있겠지만, 그 중에서 난 우리팀이 가장 변화에 적응할 수 있는 팀이 되고 싶다. 솔직히 더 본심을 이야기하면 내가 있는 조직이 언제나 변화에 가장 크게 적응하는 팀이 되고 싶다.\u003C\u002Fp\u003E\n\u003Cp\u003E내가 개발자라는 직업을 좋아하는 이유는 정말 노력하고 투자하면, 2명 혹은 3명, 혹은 그 이상 10명 치의 일을 할 수 있다는 점이다. 그렇기 때문에 더 노력하고, 갈고 닦고 싶다. 다들 알다시피, 개발자들이 개발하는 모습을 보면 코드를 고민하는 시간이 대부분이고, 검색하는 부분이 대부분의 시간을 차지하고 코드를 짜는 시간은 어찌보면 그렇게 많지 않다.\u003C\u002Fp\u003E\n\u003Cp\u003E고민과 검색하는 시간을 코드로 짜는 시간으로 바꾸고, 코드를 짜면서 그 고민과 검색하는 시간을 압도적으로 줄일 수 있으면 어떨까? 그 사람은 엄청난 시간과 에너지를 아껴서 퍼포먼스를 만들 수 있다고 생각한다.\u003C\u002Fp\u003E\n\u003Cp\u003E과거 읽은 책 중 하나가, 업무를 하다가 다른 창, 화면을 보는 것이 엄청난 집중력 저하를 일으킨다는 연구결과를 본적이 있다. 개발을 할 때도 마찬가지라고 생각한다. 그래서 좀 더 효율의 극대화, 비즈니스의 방향 추구 등이 내 요즘 최고의 관심사다.\u003C\u002Fp\u003E\n\u003Cbr\u002F\u003E\n\u003Ch2 id=\"배포하고-발생한-이슈\"\u003E\u003Ca href=\"#%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B3%A0-%EB%B0%9C%EC%83%9D%ED%95%9C-%EC%9D%B4%EC%8A%88\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E배포하고 발생한 이슈\u003C\u002Fh2\u003E\n\u003Cp\u003E언제나 그렇듯 큰 배포가 나가고 나면 여러가지 이슈가 발생한다. 큰 이슈는 발생하지 않도록 하나 여러 작은 이슈들이 발생한다. 그 이슈의 작고 큰 유무는 개인의 판단에 다르고, 회사 측면에서도 다르나 일종의 버그이니 얼른 해결을 해야한다고 생각한다.\u003C\u002Fp\u003E\n\u003Cbr\u002F\u003E\n\u003Ch3 id=\"1-couchbase-와-mongodb-전환시-map-형태의-차이\"\u003E\u003Ca href=\"#1-couchbase-%EC%99%80-mongodb-%EC%A0%84%ED%99%98%EC%8B%9C-map-%ED%98%95%ED%83%9C%EC%9D%98-%EC%B0%A8%EC%9D%B4\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E1. Couchbase 와 MongoDB 전환시 Map 형태의 차이\u003C\u002Fh3\u003E\n\u003Cp\u003E놀랍게도 이커머스의 초창기 회사에 있기에 여러가지 아이디 계정을 보게된다. 아이디는 대부분의 서비스에서 유효한 키를 차지하기에 한번 생기면 바꾸기가 거의 어렵다. 특히 몇년동안 쌓인 잘못된 정책의 데이터가 이후 변경을 힘들게한다. 특히 초창기의 웹 서비스에서는 아이디에 대한 규칙이 없기 때문에 그 규칙을 깬 계정으로 인해 여러 서비스에서 방어로직을 넣고 서비스 이슈가 발생하게 됩니다. (대표적인 예시가 특수문자와 공백입니다.)\u003C\u002Fp\u003E\n\u003Cp\u003E근데 이번에 작업을 하면서 특정 계정의 경우, 아이디에 \".\" 가 들어가는 문제가 있었습니다.  Couchbase에서는 map 데이터에 \".\" 가 들어가는게 허용이 되는데, MongoDB에서는 이 값을 사용할 수가 없습니다. 그래서 싱크 때 여러 버그가 터지는 케이스가 있었습니다. 이런 부분을 치환해서 저장을 해야하는데, 치환해서 저장한다는 것은 다른 곳에서도 볼때마다 치환해서 봐야한다는 사실을 의미합니다. 즉, 여러 서비스에서 공통적으로 사용해야 한다는 것입니다.\u003C\u002Fp\u003E\n\u003Cbr\u002F\u003E\n\u003Ch3 id=\"2-급격한-성능-저하\"\u003E\u003Ca href=\"#2-%EA%B8%89%EA%B2%A9%ED%95%9C-%EC%84%B1%EB%8A%A5-%EC%A0%80%ED%95%98\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E2. 급격한 성능 저하\u003C\u002Fh3\u003E\n\u003Cp\u003Ecouchbase에서 mongodb로 전환했을 때 바로 성능이 따라오냐는 다른 문제입니다. 그리고 그 문제는 직접적으로 발생했습니다. 따라서 어떤식으로든 최적화가 필요한 상태입니다. 기존에서 couchbase에서 나오던 latency의 2배 ~ 3배 정도로 더 느려졌습니다.\u003C\u002Fp\u003E\n\u003Cp\u003E추측은 다음과 같습니다.\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003Eid로 접근을 특정 value로 접근을 해서 (다만, value로 indexing 처리를 했습니다.)\u003C\u002Fli\u003E\n\u003Cli\u003Emongodb보다 couchbase가 더 빨라서.\u003C\u002Fli\u003E\n\u003Cli\u003E최적화가 되지 않아서.\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cbr\u002F\u003E\n\u003Ch3 id=\"3-일부-데이터-검증-방법\"\u003E\u003Ca href=\"#3-%EC%9D%BC%EB%B6%80-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EA%B2%80%EC%A6%9D-%EB%B0%A9%EB%B2%95\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E3. 일부 데이터 검증 방법\u003C\u002Fh3\u003E\n\u003Cp\u003E데이터 양을 비교하는 것도 고민을 해야합니다. couchbase와 mongodb의 document 수가 같은지, 다르다면 어디서 차이가 나는지 걱정을 해야합니다.\u003C\u002Fp\u003E\n\u003Cp\u003Emongodb의 퍼포먼스를 올릴 수 있는 코드를 찾고 있고, 그 코드를 체크할 부분을 찾아야합니다.\u003C\u002Fp\u003E\n\u003Cp\u003E대표적인 예시로 find 가 아닌 findTop 으로 바꿨고, 더 빠른 처리를 고민하고 있습니다.\u003C\u002Fp\u003E\n\u003Cp\u003Eprimary index와 secondary index의 차이가 있는지도 체크가 필요합니다.\u003C\u002Fp\u003E\n\u003Cp\u003E어떤식으로 할 수 있을까... 생각보다 코드가 안나온다... 검색 체크가 필요한데...\u003C\u002Fp\u003E\n\u003Cbr\u002F\u003E\n\u003Ch2 id=\"해결-방식\"\u003E\u003Ca href=\"#%ED%95%B4%EA%B2%B0-%EB%B0%A9%EC%8B%9D\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E해결 방식\u003C\u002Fh2\u003E\n\u003Ch3 id=\"1-mongodb-converter-사용\"\u003E\u003Ca href=\"#1-mongodb-converter-%EC%82%AC%EC%9A%A9\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E1. MongoDB Converter 사용\u003C\u002Fh3\u003E\n\u003Cp\u003E\u003Ccode class=\"language-text\"\u003E&quot;.&quot;\u003C\u002Fcode\u003E 을 어떤걸로 전환을 할까 했는데, 결국은 아스키로 저장을 했습니다. \u003Ccode class=\"language-text\"\u003E&quot;&amp;#46;&quot;\u003C\u002Fcode\u003E 으로 변경해서 저장을 했고, 그 외에 어떤 특수문자를 할까 고민을 했는데 괜찮은 게 없었다.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-java\"\u003E\u003Ccode class=\"language-java\"\u003E\u003Cspan class=\"token annotation punctuation\"\u003E@Bean\u003C\u002Fspan\u003E\n\u003Cspan class=\"token keyword\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EsetUpMongoEscapeCharacterConversion\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    mongoConverter\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003EsetMapKeyDotReplacement\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E\"&amp;#46;\"\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cbr\u002F\u003E\n\u003Ch3 id=\"2-성능-저하-해결\"\u003E\u003Ca href=\"#2-%EC%84%B1%EB%8A%A5-%EC%A0%80%ED%95%98-%ED%95%B4%EA%B2%B0\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E2. 성능 저하 해결\u003C\u002Fh3\u003E\n\u003Cp\u003E데이터가 어디서 시간이 많이 걸리는지 체크를 했는데, 특정 document를 접근하는 경우가 제일 많은 시간과 요청이 있었다. 그 값은 자주 변경되는 값이 아니기 때문에 1분 캐시를 먹여서 해결을 했다. 정말 드라마틱하게 mongodb의 트래픽을 줄였고 서비스 적으로도 이슈가 없었다.\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fgithub.com\u002FAzderica\u002Ftil\u002Fassets\u002F42582516\u002Fa8c9ef2a-fbb5-4eac-a813-3f3d72ab9df5\" alt=\"image\"\u003E\u003C\u002Fp\u003E\n\u003Cp\u003Emongodb에서도 건드릴 수 있는 부분이 있으면 체크를 할려고 했으나, 그 부분을 잘 해결되지 않았다.\u003C\u002Fp\u003E\n\u003Ch3 id=\"3-노가다로-맞춘다\"\u003E\u003Ca href=\"#3-%EB%85%B8%EA%B0%80%EB%8B%A4%EB%A1%9C-%EB%A7%9E%EC%B6%98%EB%8B%A4\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E3. 노가다로 맞춘다.\u003C\u002Fh3\u003E\n\u003Cp\u003E데이터는 억지로 맞추고, 버그 발생시 즉각적 대응 및 버그를 계속 체크한다.\u003C\u002Fp\u003E\n\u003Cbr\u002F\u003E\n\u003Ch2 id=\"어떻게-더-나아갈-수-있을까\"\u003E\u003Ca href=\"#%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8D%94-%EB%82%98%EC%95%84%EA%B0%88-%EC%88%98-%EC%9E%88%EC%9D%84%EA%B9%8C\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E어떻게 더 나아갈 수 있을까?\u003C\u002Fh2\u003E\n\u003Cp\u003E가장 어려운 부분이라고 생각한다. 특히, 나는 야근과 주말일이 가득한 사람이고 내 개인적인 욕심이 많기 때문에 남한테 이를 강요할 수는 없다. 최근 토스에서 이야기가 많은 것처럼, 나또한 내 욕심이 남의 철학을 건드려서는 안된다고 생각한다. 각자 자신의 스타일이 있고 그 스타일을 조율하는 것이 중요하다고 생각한다.\u003C\u002Fp\u003E\n\u003Cp\u003E함께 가며, 전략적으로 가는 방법. 그리고 그들의 본심을 꺼낼 수 있는 방식을 가고 싶다. 그리고 나는 남들을 평가할 수 없으나, 남들에게 무언가를 부탁하려면 그 이상의 작업을 해야한다고 생각한다. 그래서 나는 남들이 하는 작업의 두배이상을 하려고한다. 그래야지, 다른 사람에게 뭔가를 이야기할 명분이 생긴다고 생각한다.\u003C\u002Fp\u003E\n","cover_image":null}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.e68d9618.js" defer></script><script src="/assets/js/page--src--templates--post-vue.e5244b0f.js" defer></script>
</body>

</html>